#!/usr/bin/env ruby
if ARGV.size == 0 || ARGV.include?('--help')
  puts "Usage: crocodile [options] source dest" 
  puts ""
  puts "  --start          Start the selenium server"
  puts "  --stop           Stop the selenium server"
  puts "  --width=WIDTH    Set the width of the window"
  puts "  --height=HEIGHT  Set the height of the window"
  puts "  --script=SCRIPT  Execute arbitrary javascript in the window"
  puts "  --help"
  exit
end

# Grab the params
params = ARGV.reject{|arg| arg =~ /^--/}
source = params[0] rescue nil
dest = params[1] rescue nil

raise "You're not doing it right" if source.empty? || dest.empty?

require 'rubygems'
require 'crocodile'
require 'net/http'

def opt(name)
  p = ARGV.select{|arg| arg =~ /^--#{name}=/}.first
  p.gsub(/^--#{name}=/, '') if p
end

width = opt "width"
height = opt "height"
script = opt "script"

puts "Starting Selenium"
options = {}
options[:start] = true if ARGV.include? '--start'
options[:stop] = true if ARGV.include? '--start'
options[:width] = width if width
options[:height] = height if height

source_uri = URI.parse(source)
if (source_uri.relative?)
  source_path = File.expand_path(source)
  source_base = "file://"
else
  source_path = source_uri.path
  source_base = source.gsub(Regexp.new(source_path + "$"), '')
end  
Crocodile.snap(source_base, source_path, dest, options) do |browser|
  browser.get_eval script if script
end
puts "Done"
